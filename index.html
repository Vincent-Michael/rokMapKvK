<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Map Overlay</title>
<style>
  :root{
    --gold-dark:#FFC107; --gold-light:#D4AF37;
    --bg:#121212; --fg:#eaeaea; --panel:#1b1b1b; --panel-2:#222;
    --border:#343434; --subtle:#2a2a2a;
    --btn-bg:#1f1f1f; --btn-fg:#ffffff; --btn-border:#333;
    --badge-bg:#1a1a1a; --badge-fg:#eaeaea; --badge-border:#333;
    --input-bg:#101010; --input-fg:#eaeaea; --input-border:#3a3a3a;
    --accent:#FFC107;
  }
  body[data-theme="light"]{
    --bg:#f5f7fb; --fg:#0f172a; --panel:#ffffff; --panel-2:#f2f4f8;
    --border:#c9ced6; --subtle:#e6e9ef;
    --btn-bg:#111827; --btn-fg:#ffffff; --btn-border:#0b1220;
    --badge-bg:#ffffff; --badge-fg:#0f172a; --badge-border:#c9ced6;
    --input-bg:#ffffff; --input-fg:#0f172a; --input-border:#c9ced6;
    --accent:#c69300;
  }
  body{
    margin:0; font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--fg);
    display:flex; flex-direction:column; align-items:center; gap:12px; padding:14px;
  }
  .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:center}
  .btn,.badge,select,input[type="text"]{font-size:14px}
  .btn{ padding:8px 12px; border-radius:10px; border:1px solid var(--btn-border);
        background:var(--btn-bg); color:var(--btn-fg); cursor:pointer;
        transition:box-shadow .15s, transform .02s }
  .btn:hover{box-shadow:0 0 0 3px color-mix(in oklab, var(--btn-border) 40%, transparent)}
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 60%, transparent)}
  .badge{padding:6px 10px; border-radius:999px; border:1px solid var(--badge-border); background:var(--badge-bg); color:var(--badge-fg)}
  label input{display:none}
  .file{border:1px dashed var(--border); padding:8px 12px; border-radius:10px; cursor:pointer; background:var(--panel)}
  .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center}
  .sep{width:1px; height:20px; background:var(--border)}
  canvas{max-width:100%; height:auto; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.35); background:#121212}
  .hint{opacity:.85; font-size:13px; margin-top:-6px}

  /* Modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{width:min(1100px,96vw); max-height:90vh; overflow:hidden; background:var(--panel); color:var(--fg);
    border:1px solid var(--border); border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.6); display:flex; flex-direction:column}
  .modal header{display:flex; align-items:center; gap:10px; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--subtle)}
  .modal h3{margin:0; font-size:18px}
  .close{background:var(--panel-2); border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer}
  .modal .content{padding:12px 16px; overflow:auto}
  .modal footer{display:flex; justify-content:space-between; gap:8px; padding:12px 16px; border-top:1px solid var(--subtle); background:color-mix(in oklab, var(--panel) 85%, black 15%)}
  .small{font-size:12px; opacity:.85}

  /* Tables in modals */
  .cm-table,.et-table{border:1px solid var(--border); border-radius:10px; overflow:hidden}
  .cm-head,.cm-row{display:grid; grid-template-columns:42px 1fr 140px 120px 160px 140px 160px; align-items:center}
  .cm-head{background:var(--panel-2); font-weight:600}
  .cm-head>div{padding:10px 12px; border-right:1px solid var(--subtle)}
  .cm-head>div:last-child{border-right:none}
  .cm-body{max-height:min(56vh,620px); overflow:auto; background:var(--panel)}
  .cm-row:nth-child(odd){background:color-mix(in oklab, var(--panel) 92%, white 8%)}
  .cm-row:nth-child(even){background:color-mix(in oklab, var(--panel) 86%, white 14%)}
  .cm-row>div{padding:8px 10px; border-top:1px solid var(--subtle); border-right:1px solid var(--subtle)}
  .cm-row>div:last-child{border-right:none}
  .cm-input{width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--input-fg)}
  .cm-actions{display:flex; gap:6px; flex-wrap:wrap}
  .cm-icon{padding:6px 8px; border-radius:8px; border:1px solid var(--btn-border); background:var(--btn-bg); cursor:pointer}
  .swatch{width:20px; height:20px; border-radius:50%; border:1px solid var(--border); display:inline-block; margin-right:8px}
  .inline{display:flex; align-items:center; gap:8px}

  .et-head,.et-row{display:grid; grid-template-columns:140px 160px 160px 112px 112px; align-items:center}
  .et-head{background:var(--panel-2); font-weight:600}
  .et-body{max-height:min(56vh,620px); overflow:auto; background:var(--panel)}
  .et-row:nth-child(odd){background:color-mix(in oklab, var(--panel) 92%, white 8%)}
  .et-row:nth-child(even){background:color-mix(in oklab, var(--panel) 86%, white 14%)}
  .et-row>div{padding:8px 10px; border-top:1px solid var(--subtle); border-right:1px solid var(--subtle)}
  .et-row>div:last-child{border-right:none}
  .et-input{width:100%; padding:8px 10px; border:1px solid var(--input-border); border-radius:8px; background:var(--input-bg); color:var(--input-fg)}
  .et-input.invalid{border-color:#d32f2f; box-shadow:0 0 0 3px color-mix(in oklab, #d32f2f 25%, transparent)}

  /* Copyright footer */
  .copyright {
    position: fixed;
    right: 12px;
    bottom: 10px;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: color-mix(in oklab, var(--panel) 85%, black 15%);
    color: var(--fg);
    font-size: 12px;
    opacity: .85;
    z-index: 60;
    user-select: text;
  }

  /* HIDE DEBUG BUTTON */
  #toggleDebug { display: none !important; }
</style>
</head>
<body data-theme="dark">
  <div class="toolbar row">
    <label class="file badge">Choose Map (PNG/JPG)
      <input id="fileInput" type="file" accept="image/*"/>
    </label>
    <select id="mode" class="badge">
      <option value="dark" selected>Dark Mode</option>
      <option value="light">Light Mode</option>
    </select>
    <span class="badge">Transparency: <input id="alpha" type="range" min="0.30" max="0.95" step="0.01" value="0.70"></span>
    <span class="badge">Panel Size: <input id="psize" type="range" min="0.60" max="1.60" step="0.01" value="0.60"></span>
    <span class="badge">Map Scale: <input id="mapScale" type="range" min="0.80" max="1.40" step="0.01" value="1.00"></span>

    <span class="badge">Map Preset:
      <select id="preset">
        <option value="custom">Custom (keep current)</option>
        <option value="orleans6">Siege of Orl√©ans (6)</option>
        <option value="heroic4" selected>Heroic Anthem (4)</option>
        <option value="warriors6">Warriors Unbound (6)</option>
        <option value="tide4">Tide of Wars (4)</option>
        <option value="storm6">Storm of Stratagems (6)</option>
        <option value="invictus6">Alliance Invictus (6)</option>
        <option value="britain4">King of all Britain (4)</option>
        <option value="keener6">Keener Blades (6)</option>
      </select>
    </span>

    <span class="badge">Title: <input id="titleText" type="text" value="Heroic Anthem" style="width:220px"></span>
    <span class="sep"></span>
    <button id="openCampMgr" class="btn">Manage Camps</button>
    <button id="openData" class="btn">Edit Data</button>
    <button id="toggleSummary" class="btn">Summary: ON</button>
    <button id="resetAllPos" class="btn">Reset Positions</button>
    <span class="sep"></span>
    <button id="toggleDrag" class="btn">Drag: ON</button>
    <button id="toggleDebug" class="btn">Debug: OFF</button>
    <button id="downloadPng" class="btn">Download PNG</button>
    <span class="badge">Canvas: 1600√ó900</span>
  </div>

  <div class="hint">Choose a preset to auto-load the map.</div>
  <canvas id="cv" width="1600" height="900"></canvas>

  <!-- Camp Manager -->
  <div id="campMgrWrap" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>Manage Camps</h3>
        <div class="row">
          <button id="addCamp" class="btn">+ Camp</button>
          <button id="closeCampMgr" class="close">Close</button>
        </div>
      </header>
      <div class="content">
        <div class="cm-table">
          <div class="cm-head">
            <div>#</div><div>Name</div><div>Color</div><div>Total Tint</div><div>Status</div><div>Actions</div><div>Info</div>
          </div>
          <div class="cm-body" id="cmBody"></div>
        </div>
      </div>
      <footer>
        <div class="small">Status = border color (ally/enemy). Total Tint = background of ‚ÄúTotal‚Äù row.</div>
        <div class="row"><button id="saveCampMgr" class="btn">Save & Redraw</button></div>
      </footer>
    </div>
  </div>

  <!-- Edit Data -->
  <div id="editorWrap" class="modal-backdrop">
    <div class="modal">
      <header>
        <h3>Edit Data (KD / Power / KP)</h3>
        <div class="row" style="gap:8px">
          <button id="saveData" class="btn">Save Data</button>
          <button id="loadData" class="btn">Load Data</button>
          <button id="exportData" class="btn">Export JSON</button>
          <button id="importData" class="btn">Import JSON</button>
          <button id="closeEditor" class="close">Close</button>
        </div>
      </header>
      <div class="content">
        <div class="row" style="gap:14px;align-items:flex-end;flex-wrap:wrap">
          <label class="badge">Camp:
            <select id="campSelect"></select>
          </label>
          <button id="addRow" class="btn">+ Row</button>
          <button id="resetCamp" class="btn" style="background:#6a1a1a;border-color:#6a1a1a">Clear Camp Data</button>
          <span class="small">Power/KP: e.g. <code>23,8B</code> or <code>950M</code></span>
        </div>
        <div class="et-table" style="margin-top:10px">
          <div class="et-head"><div>KD</div><div>Power</div><div>KP</div><div>Order</div><div>Actions</div></div>
          <div class="et-body" id="rowsBody"></div>
        </div>
      </div>
      <footer>
        <div class="small">Invalid inputs are highlighted in red.</div>
        <div class="row">
          <button id="applyData" class="btn">Save & Redraw</button>
          <button id="cancelData" class="btn">Cancel</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- Copyright footer (UI) -->
  <div class="copyright">
    ¬© <span id="cpYear"></span> ‚Äî Vinc69cmAl√∏T#2359
  </div>

<script>
/* ====== Constants & DOM ====== */
const DATA_KEY="siege_overlay_data_v13";
const PWIDTH0=0.28, PHEIGHT0=0.18;

const cv=document.getElementById("cv"), ctx=cv.getContext("2d");
const fileInput=document.getElementById("fileInput");
const modeSel=document.getElementById("mode");
const alphaInput=document.getElementById("alpha");
const panelSizeInput=document.getElementById("psize");
const mapScaleInput=document.getElementById("mapScale");
const titleInput=document.getElementById("titleText");
const presetSel=document.getElementById("preset");
const dlBtn=document.getElementById("downloadPng");
const toggleDragBtn=document.getElementById("toggleDrag");
const toggleDebugBtn=document.getElementById("toggleDebug");
const resetAllPosBtn=document.getElementById("resetAllPos");
const toggleSummaryBtn=document.getElementById("toggleSummary");

const campMgrWrap=document.getElementById("campMgrWrap");
const openCampMgr=document.getElementById("openCampMgr");
const closeCampMgr=document.getElementById("closeCampMgr");
const cmBody=document.getElementById("cmBody");
const addCampBtn=document.getElementById("addCamp");
const saveCampMgrBtn=document.getElementById("saveCampMgr");

const editorWrap=document.getElementById("editorWrap");
const openDataBtn=document.getElementById("openData");
const closeEditor=document.getElementById("closeEditor");
const campSelect=document.getElementById("campSelect");
const rowsBody=document.getElementById("rowsBody");
const addRowBtn=document.getElementById("addRow");
const resetCampBtn=document.getElementById("resetCamp");
const applyDataBtn=document.getElementById("applyData");
const cancelDataBtn=document.getElementById("cancelData");
const saveDataBtn=document.getElementById("saveData");
const loadDataBtn=document.getElementById("loadData");
const exportDataBtn=document.getElementById("exportData");
const importDataBtn=document.getElementById("importData");

/* Copyright year */
const cpYearEl = document.getElementById("cpYear");
if (cpYearEl) cpYearEl.textContent = new Date().getFullYear();

/* ====== State ====== */
let mapImg=null, mode="dark", dragOn=true, debug=false;
let camps=[], pos={};
let summaryGroupPos=[0.50,0.50], lastSummaryGroupLayout=null, showSummary=true;
let dragging=null, draggingSummary=false, lastLayout=null, lastCampRects={};
let currentEditorCampIndex=0;

/* ====== Utils ====== */
function uid(){return'c_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)}
function clamp(a,l,h){return Math.max(l,Math.min(h,a))}
function hexToRgb(hex){let m=String(hex||'').replace('#',''); if(m.length===3)m=m.split('').map(c=>c+c).join(''); const n=parseInt(m||'000000',16); return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}}
function mix(hex,other='#000',t=0.75){const a=hexToRgb(hex),b=hexToRgb(other);const r=Math.round(a.r*(1-t)+b.r*t),g=Math.round(a.g*(1-t)+b.g*t),bl=Math.round(a.b*(1-t)+b.b*t);return'#'+[r,g,bl].map(v=>('0'+v.toString(16)).slice(-2)).join('')}
function hexWithAlpha(hex,a){const{r,g,b}=hexToRgb(hex);return`rgba(${r},${g},${b},${a})`}
function setFont(px,w){ctx.font=(w?w+" ":"")+px+"px Inter, Segoe UI, Arial, sans-serif"}
function drawTextFit(text,cx,cy,maxW,px,weight,color){let s=px;setFont(s,weight);let m=ctx.measureText(text);while(m.width>maxW&&s>9){s-=1;setFont(s,weight);m=ctx.measureText(text)}ctx.fillStyle=color;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(text,cx,cy)}
function normalizePowerStr(s){if(!s)return"";s=String(s).trim().replace(/\s+/g,"");if(/[0-9]\.[0-9]/.test(s)&&!/,[0-9]/.test(s))s=s.replace('.',',');if(/[bB]$/.test(s))s=s.replace(/[bB]$/,'B');else if(/[mM]$/.test(s))s=s.replace(/[mM]$/,'M');const u=/[BM]$/.test(s)?s.slice(-1):'';let core=u?s.slice(0,-1):s;if(core.includes(",")&&core.includes("."))core=core.replace(/\./g,"");return core+u}
function validKD(s){return/^\d{1,6}$/.test(String(s).trim())}
function validBM(s){s=normalizePowerStr(s);if(!s)return false;const m=s.match(/^(\d+(?:[.,]\d+)?)\s*([BM])$/);if(!m)return false;const num=parseFloat(m[1].replace(',','.'));return!isNaN(num)&&num>=0}
function parseToBillions(str){let s=String(str||'').trim();if(!s)return NaN;s=s.replace(/\s+/g,'');let u='B';if(/[bB]$/.test(s)){u='B';s=s.slice(0,-1)}else if(/[mM]$/.test(s)){u='M';s=s.slice(0,-1)}if(s.includes(',')&&s.includes('.'))s=s.replace(/\./g,'');s=s.replace(',', '.');const v=parseFloat(s);if(isNaN(v))return NaN;return u==='M'?v/1000:v}
function fmtB(v){return(v.toFixed(1)).replace('.',',')+'B'}
function withTotals(rows){let p=0,k=0;(rows||[]).forEach(r=>{const pv=parseToBillions(r[1]);if(!isNaN(pv))p+=pv;const kv=parseToBillions(r[2]);if(!isNaN(kv))k+=kv});return[...(rows||[]),["Total",fmtB(p),fmtB(k)]]}
function getPresetTitle(){const opt=presetSel.options[presetSel.selectedIndex];return(opt?.text||"").replace(/\s*\(\d+\)\s*$/,'').trim()}
function getTotalTint(c){return mode==="light"?(c.totalTintLight||mix(c.color,"#fff",0.85)):(c.totalTint||mix(c.color,"#000",0.75))}
function getStanceStroke(c){const neutral=(mode==="dark")?"#CFCFCF":"#555";if(c.stance==="ally")return{color:"#4CAF50",width:10};if(c.stance==="enemy")return{color:"#E53935",width:10};return{color:neutral,width:7}}
function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); } /* for debug labels */

/* ====== Auto map images per preset ====== */
const presetImages = {
  heroic4:    "ha.png",
  warriors6:  "wu.png",
  tide4:      "tides.png",
  storm6:     "stratagems.png",
  invictus6:  "ai.png",
  britain4:   "kob.png",
  keener6:    "kb.png",
  orleans6:   "orleans.png",
};
function loadMapForPreset(key){
  const src = presetImages[key];
  if(!src) return;
  const img = new Image();
  img.onload = () => { mapImg = img; draw(); };
  img.src = src;
}

/* ====== Presets (mit aktuellen Positionen) ====== */
const mapPresets={
  orleans6:{camps:[
    {name:"Brittany",color:"#BDBDBD",pos:[0.18,0.12]},
    {name:"Bourbon",color:"#66BB6A",pos:[0.86,0.31]},
    {name:"La Marche",color:"#42A5F5",pos:[0.35,0.83]},
    {name:"Picardy",color:"#BA68C8",pos:[0.60,0.07]},
    {name:"Auvergne",color:"#FFCA28",pos:[0.78,0.80]},
    {name:"Poitou",color:"#EF5350",pos:[0.11,0.47]},
  ]},
  heroic4:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.24,0.17]},
    {name:"Earth",color:"#8B5E3C",pos:[0.77,0.19]},
    {name:"Water",color:"#3B82F6",pos:[0.24,0.71]},
    {name:"Wind",color:"#8B5CF6",pos:[0.78,0.71]},
  ]},
  tide4:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.25,0.12]},
    {name:"Earth",color:"#8B5E3C",pos:[0.78,0.14]},
    {name:"Water",color:"#3B82F6",pos:[0.20,0.76]},
    {name:"Wind",color:"#8B5CF6",pos:[0.83,0.76]},
  ]},
  warriors6:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.16,0.11]},
    {name:"Earth",color:"#8B5E3C",pos:[0.51,0.08]},
    {name:"Wind",color:"#8B5CF6",pos:[0.85,0.16]},
    {name:"Daybreak",color:"#F59E0B",pos:[0.15,0.72]},
    {name:"Greenwood",color:"#22C55E",pos:[0.49,0.72]},
    {name:"Water",color:"#3B82F6",pos:[0.88,0.72]},
  ]},
  storm6:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.19,0.15]},
    {name:"Earth",color:"#8B5E3C",pos:[0.48,0.12]},
    {name:"Wind",color:"#8B5CF6",pos:[0.81,0.12]},
    {name:"Daybreak",color:"#F59E0B",pos:[0.13,0.78]},
    {name:"Greenwood",color:"#22C55E",pos:[0.46,0.81]},
    {name:"Water",color:"#3B82F6",pos:[0.86,0.79]},
  ]},
  invictus6:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.38,0.07]},
    {name:"Earth",color:"#8B5E3C",pos:[0.63,0.06]},
    {name:"Wind",color:"#8B5CF6",pos:[0.88,0.43]},
    {name:"Daybreak",color:"#F59E0B",pos:[0.14,0.44]},
    {name:"Greenwood",color:"#22C55E",pos:[0.19,0.76]},
    {name:"Water",color:"#3B82F6",pos:[0.80,0.73]},
  ]},
  britain4:{camps:[
    {name:"Northumbria",color:"#8B5CF6",pos:[0.41,0.07]},
    {name:"East Anglia",color:"#3B82F6",pos:[0.80,0.52]},
    {name:"Wessex",color:"#F59E0B",pos:[0.39,0.79]},
    {name:"Mercia",color:"#EF4444",pos:[0.16,0.36]},
  ]},
  keener6:{camps:[
    {name:"Fire",color:"#EF4444",pos:[0.28,0.06]},
    {name:"Earth",color:"#8B5E3C",pos:[0.78,0.09]},
    {name:"Wind",color:"#8B5CF6",pos:[0.83,0.37]},
    {name:"Daybreak",color:"#F59E0B",pos:[0.17,0.33]},
    {name:"Greenwood",color:"#22C55E",pos:[0.33,0.82]},
    {name:"Water",color:"#3B82F6",pos:[0.59,0.86]},
  ]},
};

/* ====== Models & Preset apply ====== */
function makeCamp(name,color,rows=[["","",""]],stance="neutral",totalTint=null){
  return{id:uid(),name,color,totalTint:totalTint||mix(color,"#000",0.75),stance,rows}
}
function applyPreset(key,keep=false){
  const p=mapPresets[key]; if(!p) return;
  const nameToRows={}; if(keep) camps.forEach(c=> nameToRows[c.name]=(c.rows||[]).map(r=>[...r]));
  pos={};
  camps=p.camps.map(c=>{
    const camp=makeCamp(c.name,c.color,nameToRows[c.name]||[["","",""]]);
    pos[camp.id]=c.pos; return camp;
  });
  summaryGroupPos=[0.50,0.50]; draw();
}

/* ====== UI bindings ====== */
modeSel.onchange=()=>{mode=modeSel.value;document.body.dataset.theme=mode;draw()};
document.body.dataset.theme=mode;

fileInput.addEventListener('change',()=>{
  const f=fileInput.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>{mapImg=img;draw()}; img.src=URL.createObjectURL(f);
});
[alphaInput,panelSizeInput,mapScaleInput,titleInput].forEach(el=> el.oninput=()=>draw());

toggleDragBtn.onclick=()=>{dragOn=!dragOn;toggleDragBtn.textContent=`Drag: ${dragOn?"ON":"OFF"}`;toggleDragBtn.style.opacity=dragOn?"1":"0.7"};
// Debug-Button ist ausgeblendet; Handler bleibt optional ungenutzt
if (toggleDebugBtn) toggleDebugBtn.onclick=()=>{};
toggleSummaryBtn.onclick=()=>{showSummary=!showSummary;toggleSummaryBtn.textContent=`Summary: ${showSummary?"ON":"OFF"}`;draw()};
resetAllPosBtn.onclick=()=>{const v=presetSel.value; if(v!=="custom"&&mapPresets[v]){titleInput.value=getPresetTitle();applyPreset(v,true);loadMapForPreset(v);}else{draw()}};
dlBtn.onclick=()=>{const a=document.createElement("a");a.download=`MapOverlay_${mode}.png`;a.href=cv.toDataURL("image/png");a.click()};
presetSel.onchange=()=>{const v=presetSel.value;if(v==="custom")return;titleInput.value=getPresetTitle();applyPreset(v,false);loadMapForPreset(v)};

/* ====== Dragging ====== */
cv.addEventListener("mousedown",ev=>{
  if(!dragOn||!lastLayout)return;
  const r=cv.getBoundingClientRect(),mx=(ev.clientX-r.left)*(cv.width/r.width),my=(ev.clientY-r.top)*(cv.height/r.height);
  for(const id in lastCampRects){const {L,T,W,H}=lastCampRects[id];
    if(mx>=L&&mx<=L+W&&my>=T&&my<=T+H){const cx=L+W/2,cy=T+H/2;dragging={id,dx:mx-cx,dy:my-cy};return}
  }
  if(showSummary&&lastSummaryGroupLayout){const {x,y,w,h}=lastSummaryGroupLayout;
    if(mx>=x&&mx<=x+w&&my>=y&&my<=y+h){draggingSummary={dx:mx-(x+w/2),dy:my-(y/2+h/2)};return}}
});
cv.addEventListener("mousemove",ev=>{
  if((!dragging&&!draggingSummary)||!lastLayout)return;
  const r=cv.getBoundingClientRect(),mx=(ev.clientX-r.left)*(cv.width/r.width),my=(ev.clientY-r.top)*(cv.height/r.height);
  const {x,y,w,h}=lastLayout;
  if(dragging){
    const rect=lastCampRects[dragging.id],s=parseFloat(panelSizeInput.value||"0.60");
    const W=rect?rect.W:w*PWIDTH0*s,H=rect?rect.H:h*PHEIGHT0*s;
    let cx=mx-dragging.dx,cy=my-dragging.dy; cx=clamp(cx,x+W/2,x+w-W/2); cy=clamp(cy,y+H/2,y+h-H/2);
    pos[dragging.id]=[(cx-x)/w,(cy-y)/h]; draw();
  }else{
    const lay=lastSummaryGroupLayout||{w:w*0.6,h:h*0.22};
    let cx=mx-draggingSummary.dx,cy=my-dragging.dy; cx=clamp(cx,x+lay.w/2,x+w-lay.w/2); cy=clamp(cy,y+lay.h/2,y+h-lay.h/2);
    summaryGroupPos=[(cx-x)/w,(cy-y)/h]; draw();
  }
});
cv.addEventListener("mouseup",()=>{dragging=null;draggingSummary=false});
cv.addEventListener("mouseleave",()=>{dragging=null;draggingSummary=false});

/* ====== Drawing ====== */
function roundRect(x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}
function computePanelSizeForRows(baseW,baseH,rowsCount){const pad=8,MIN=24;const N=rowsCount+1;const minH=2*pad+N*MIN;return{W:baseW,H:Math.max(baseH,minH),N,pad}}
function drawTable(x,y,w,h,c){
  const rows=withTotals(c.rows),nBody=rows.length,nCols=3,pad=8,N=nBody+1;
  const cellW=(w-2*pad)/nCols,cellH=(h-2*pad)/N;
  const S=clamp(Math.min(cellH/24,(cellW/160)),0.65,1.6);
  const SIZE={name:clamp(Math.round(18*S),12,26),header:clamp(Math.round(14*S),11,22),body:clamp(Math.round(13*S),10,20),total:clamp(Math.round(13*S),10,20)};
  const bannerH=clamp(Math.round(28*S),20,40),bannerW=clamp(w*(0.66+0.02*Math.max(0,rows.length-3)),w*0.58,w*0.86);
  const a=clamp(parseFloat(alphaInput.value||"0.70"),0.10,0.95);
  const panelFill=(mode==="dark")?`rgba(0,0,0,${a})`:`rgba(255,255,255,${a})`;
  ctx.fillStyle=panelFill; roundRect(x,y,w,h,10); ctx.fill();
  const {color:strokeCol,width:strokeW}=getStanceStroke(c);
  ctx.lineJoin="round"; ctx.lineCap="round";
  ctx.lineWidth=strokeW+12; ctx.strokeStyle=hexWithAlpha(strokeCol,(mode==="light")?0.28:0.40); roundRect(x,y,w,h,10); ctx.stroke();
  ctx.lineWidth=strokeW; ctx.strokeStyle=strokeCol; roundRect(x,y,w,h,10); ctx.stroke();
  ctx.lineWidth=3; ctx.strokeStyle="#000"; roundRect(x,y,w,h,10); ctx.stroke();
  const bW=bannerW,bH=bannerH,bX=x+(w-bW)/2,bY=y-bH-6;
  const bAlpha=clamp(Math.max(0.75,a+0.25),0.75,0.98);
  ctx.fillStyle=hexWithAlpha(c.color,bAlpha); roundRect(bX,bY,bW,bH,10); ctx.fill(); ctx.strokeStyle=(mode==="dark")?"#000":"#333"; ctx.lineWidth=1; ctx.stroke();
  setFont(SIZE.name,"600"); ctx.strokeStyle="rgba(0,0,0,.75)"; ctx.lineWidth=3; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.strokeText(c.name,bX+bW/2,bY+bH/2+0.5); ctx.fillStyle="#fff"; ctx.fillText(c.name,bX+bW/2,bY+bH/2+0.5);
  const headers=(c.headers&&c.headers.length===3)?c.headers:["KD","Power","KP"];
  const headerAlpha=clamp(a+0.15,0.55,0.95);
  ctx.fillStyle=hexWithAlpha(c.color,headerAlpha); ctx.fillRect(x+pad,y+pad,cellW*nCols,cellH);
  headers.forEach((t,ci)=>drawTextFit(t,x+pad+ci*cellW+cellW/2,y+pad+cellH/2+0.5,cellW-8,SIZE.header,"bold","#fff"));
  const bodyFill=(mode==="dark")?`rgba(30,30,30,${a})`:`rgba(250,250,250,${a})`;
  const totalFill=hexWithAlpha(getTotalTint(c),Math.max(0.45,a));
  for(let r=0;r<nBody;r++){
    const yy=y+pad+(r+1)*cellH,isTotal=rows[r][0]==="Total";
    ctx.fillStyle=isTotal?totalFill:bodyFill; ctx.fillRect(x+pad,yy,cellW*nCols,cellH);
    for(let cc=0;cc<nCols;cc++){const col=(mode==="dark")?"#EAEAEA":"#222"; const sz=isTotal?SIZE.total:SIZE.body;
      drawTextFit(rows[r][cc],x+pad+cc*cellW+cellW/2,yy+cellH/2+0.5,cellW-8,sz,isTotal?"bold":"",col);}
  }
  const gridAlpha=clamp(a*0.9,0.20,0.60); ctx.strokeStyle=(mode==="dark")?`rgba(255,255,255,${gridAlpha})`:`rgba(0,0,0,${gridAlpha})`;
  ctx.lineWidth=clamp(1*S,0.8,1.6);
  for(let r=0;r<=N;r++){const yy=y+pad+r*cellH; ctx.beginPath(); ctx.moveTo(x+pad,yy); ctx.lineTo(x+pad+nCols*cellW,yy); ctx.stroke()}
  for(let ccc=0;ccc<=nCols;ccc++){const xx=x+pad+ccc*cellW; ctx.beginPath(); ctx.moveTo(xx,y+pad); ctx.lineTo(xx,y+pad+N*cellH); ctx.stroke()}
}
function campSum(c){let p=0,k=0;(c.rows||[]).forEach(r=>{const pv=parseToBillions(r[1]);if(!isNaN(pv))p+=pv;const kv=parseToBillions(r[2]);if(!isNaN(kv))k+=kv});return{p,k}}
function buildSummaryRows(list){return list.map(c=>{const s=campSum(c);return[c.name,fmtB(s.p),fmtB(s.k)]})}
function drawSummaryGroup(area,baseW,baseH){
  if(!showSummary){lastSummaryGroupLayout=null;return}
  const allies=camps.filter(c=>c.stance==="ally"),enemies=camps.filter(c=>c.stance==="enemy");
  const ally={id:"ally",name:"Allies",color:"#4CAF50",totalTint:(mode==="dark")?"rgba(255,255,255,.06)":"rgba(0,0,0,.05)",stance:"ally",headers:["Camp","Power","KP"],rows:buildSummaryRows(allies)};
  const enemy={id:"enemy",name:"Enemies",color:"#E53935",totalTint:(mode==="dark")?"rgba(255,255,255,.06)":"rgba(0,0,0,.05)",stance:"enemy",headers:["Camp","Power","KP"],rows:buildSummaryRows(enemies)};
  const needA=computePanelSizeForRows(baseW,baseH,ally.rows.length+1),needE=computePanelSizeForRows(baseW,baseH,enemy.rows.length+1);
  const H=Math.max(needA.H,needE.H),W=baseW,gap=18;
  let [fx,fy]=summaryGroupPos; let cx=area.x+fx*area.w,cy=area.y+fy*area.h;
  const totalW=W*2+gap,totalH=H; cx=clamp(cx,area.x+totalW/2,area.x+area.w-totalW/2); cy=clamp(cy,area.y+totalH/2,area.y+area.h-totalH/2);
  const leftX=Math.round(cx-totalW/2),topY=Math.round(cy-totalH/2);
  drawTable(leftX,topY,W,H,ally); drawTable(leftX+W+gap,topY,W,H,enemy); lastSummaryGroupLayout={x:leftX,y:topY,w:totalW,h:totalH};
}
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.fillStyle=(mode==="dark")?"#121212":"#ffffff"; ctx.fillRect(0,0,cv.width,cv.height);
  setFont(38,"bold"); ctx.textAlign="center"; ctx.textBaseline="top"; ctx.fillStyle=(mode==="dark")?"var(--gold-dark)":"var(--gold-light)";
  ctx.fillText(titleInput.value||"Map", cv.width/2, 18);
  const mapTop=80,mapMarginX=40,boxW=cv.width-mapMarginX*2,boxH=cv.height-mapTop-40;
  if(mapImg){
    const fitR=Math.min(boxW/mapImg.width, boxH/mapImg.height),r=fitR*parseFloat(mapScaleInput.value||"1.00");
    const w=Math.round(mapImg.width*r),h=Math.round(mapImg.height*r),x=Math.round((cv.width-w)/2),y=Math.round(mapTop+(boxH-h)/2);
    ctx.drawImage(mapImg,x,y,w,h); lastLayout={x,y,w,h};
    const s=parseFloat(panelSizeInput.value||"0.60"),baseW=w*PWIDTH0*s,baseH=h*PHEIGHT0*s; lastCampRects={};
    for(const c of camps){ if(!pos[c.id]) pos[c.id]=[0.5,0.5];
      const need=computePanelSizeForRows(baseW,baseH,withTotals(c.rows).length); const [fx,fy]=pos[c.id]; const cx=x+fx*w,cy=y+fy*h;
      const L=Math.round(cx-need.W/2),T=Math.round(cy-need.H/2); drawTable(L,T,need.W,need.H,c); lastCampRects[c.id]={L,T,W:need.W,H:need.H};
    }
    drawSummaryGroup({x,y,w,h},baseW,baseH);
  }else{
    setFont(16,""); ctx.fillStyle=(mode==="dark")?"#bbb":"#555"; ctx.fillText("Pick a preset (auto loads map) or upload your own image.", cv.width/2, mapTop+20);
    lastLayout=null; lastCampRects={}; lastSummaryGroupLayout=null;
  }

  /* --- Canvas watermark (export sichtbar) --- */
  (function drawCopyright(){
    const pad = 12;
    const text = `¬© ${new Date().getFullYear()} ‚Äî Vinc69cmAl√∏T#2359`;
    ctx.save();
    ctx.textAlign = "right";
    ctx.textBaseline = "bottom";
    ctx.font = "12px Inter, Segoe UI, Arial, sans-serif";
    ctx.fillStyle = (mode === "dark") ? "rgba(0,0,0,.55)" : "rgba(255,255,255,.65)";
    ctx.fillText(text, cv.width - pad + 1, cv.height - pad + 1);
    ctx.fillStyle = (mode === "dark") ? "rgba(255,255,255,.85)" : "rgba(17,17,17,.85)";
    ctx.fillText(text, cv.width - pad, cv.height - pad);
    ctx.restore();
  })();
}

/* ====== Camp Manager ====== */
openCampMgr.onclick=()=>{renderCampMgr();campMgrWrap.style.display="flex"};
closeCampMgr.onclick=()=>{campMgrWrap.style.display="none"};
addCampBtn.onclick=()=>{const id=uid();camps.push({id,name:`Camp ${camps.length+1}`,color:"#999999",totalTint:mix("#999","#000",0.75),stance:"neutral",rows:[["","",""]]});pos[id]=[0.5,0.5];renderCampMgr();draw()};
saveCampMgrBtn.onclick=()=>{[...cmBody.querySelectorAll(".cm-row")].forEach(row=>{const id=row.dataset.id,c=camps.find(x=>x.id===id);if(!c)return;c.name=row.querySelector('input[data-f="name"]').value.trim()||"Camp";c.color=row.querySelector('input[data-f="color"]').value;c.totalTint=row.querySelector('input[data-f="tint"]').value;c.stance=row.querySelector('select[data-f="stance"]').value});campMgrWrap.style.display="none";draw()};
function renderCampMgr(){
  cmBody.innerHTML="";
  camps.forEach((c,i)=>{
    const row=document.createElement("div"); row.className="cm-row"; row.dataset.id=c.id;
    row.innerHTML=`<div>${i+1}</div>
      <div><input class="cm-input" data-f="name" value="${c.name}"></div>
      <div class="inline"><span class="swatch" style="background:${c.color}"></span><input class="cm-input" data-f="color" type="color" value="${c.color}" style="width:100px;padding:4px 6px"></div>
      <div class="inline"><span class="swatch" style="background:${c.totalTint||'#222'}"></span><input class="cm-input" data-f="tint" type="color" value="${c.totalTint||'#222'}" style="width:100px;padding:4px 6px"></div>
      <div><select class="cm-input" data-f="stance">
            <option value="neutral" ${c.stance==='neutral'?'selected':''}>Neutral</option>
            <option value="ally" ${c.stance==='ally'?'selected':''}>Ally</option>
            <option value="enemy" ${c.stance==='enemy'?'selected':''}>Enemy</option>
          </select></div>
      <div class="cm-actions">
        <button class="cm-icon" data-act="autoTint">Auto Tint</button>
        <button class="cm-icon" data-act="dup">Duplicate</button>
        <button class="cm-icon" data-act="del" style="background:#6a1a1a;border-color:#6a1a1a">Delete</button>
      </div>
      <div class="small">ID: ${c.id}</div>`;
    cmBody.appendChild(row);
  });
  cmBody.querySelectorAll('input[data-f="color"]').forEach(inp=>{
    inp.oninput=()=>{const row=inp.closest('.cm-row');row.querySelectorAll('.swatch')[0].style.background=inp.value;const tint=mix(inp.value,"#000",0.75);const t=row.querySelector('input[data-f="tint"]');t.value=tint;row.querySelectorAll('.swatch')[1].style.background=tint;}
  });
  cmBody.querySelectorAll('input[data-f="tint"]').forEach(inp=> inp.oninput=()=> inp.previousElementSibling.style.background=inp.value );
  cmBody.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.onclick=()=>{const row=btn.closest('.cm-row');const id=row.dataset.id;const c=camps.find(x=>x.id===id);if(!c)return;const act=btn.dataset.act;
      if(act==="autoTint"){const col=row.querySelector('input[data-f="color"]').value;const tint=mix(col,"#000",0.75);row.querySelector('input[data-f="tint"]').value=tint;row.querySelectorAll('.swatch')[1].style.background=tint;}
      if(act==="dup"){const copy={...c,id:uid(),name:(row.querySelector('input[data-f="name"]').value||c.name)+" (Copy)",rows:c.rows.map(r=>[...r])};camps.splice(camps.indexOf(c)+1,0,copy);pos[copy.id]=[...(pos[c.id]||[0.5,0.5])];renderCampMgr();}
      if(act==="del"){if(!confirm(`Delete camp "${c.name}"?`))return;camps=camps.filter(x=>x.id!==id);delete pos[id];renderCampMgr();draw();}
    };
  });
  cmBody.querySelectorAll('select[data-f="stance"]').forEach(sel=> sel.onchange=()=>{const id=sel.closest('.cm-row').dataset.id;const c=camps.find(x=>x.id===id);if(c){c.stance=sel.value;draw();}});
}

/* ====== Edit Data (autosave) ====== */
openDataBtn.onclick=()=>{openEditor()};
closeEditor.onclick=()=>{editorWrap.style.display="none"};
cancelDataBtn.onclick=()=>{editorWrap.style.display="none"};
function openEditor(){campSelect.innerHTML=camps.map((c,i)=>`<option value="${i}">${c.name}</option>`).join("");currentEditorCampIndex=parseInt(campSelect.value||"0",10);renderRows();editorWrap.style.display="flex"}
function rowTemplate(i,kd,pw,kp){return`
  <div class="et-row">
    <div><input class="et-input" data-i="${i}" data-f="kd"  value="${kd||""}" placeholder="e.g. 2359"></div>
    <div><input class="et-input" data-i="${i}" data-f="pow" value="${pw||""}" placeholder="e.g. 23,8B"></div>
    <div><input class="et-input" data-i="${i}" data-f="kp"  value="${kp||""}"  placeholder="e.g. 1.234,5B"></div>
    <div class="cm-actions"><button class="cm-icon" data-move="${i}" data-dir="-1">‚¨ÜÔ∏è</button><button class="cm-icon" data-move="${i}" data-dir="1">‚¨áÔ∏è</button></div>
    <div class="cm-actions"><button class="cm-icon" data-del="${i}" style="background:#6a1a1a;border-color:#6a1a1a">üóëÔ∏è</button></div>
  </div>`}
function renderRows(){const idx=parseInt(campSelect.value||"0",10),r=camps[idx]?.rows||[];rowsBody.innerHTML=r.map((row,i)=>rowTemplate(i,row[0],row[1],row[2])).join("");
  rowsBody.querySelectorAll("button[data-del]").forEach(b=>b.onclick=()=>{const i=parseInt(b.dataset.del,10);camps[idx].rows.splice(i,1);renderRows()});
  rowsBody.querySelectorAll("button[data-move]").forEach(b=>b.onclick=()=>{const i=parseInt(b.dataset.move,10),d=parseInt(b.dataset.dir,10);const j=i+d;if(j<0||j>=camps[idx].rows.length)return;const t=camps[idx].rows[i];camps[idx].rows[i]=camps[idx].rows[j];camps[idx].rows[j]=t;renderRows()});
  rowsBody.querySelectorAll("input.et-input").forEach(inp=>{const f=inp.dataset.f;const val=()=>{if(f==="kd")inp.classList.toggle("invalid",!validKD(inp.value));else{inp.value=normalizePowerStr(inp.value);inp.classList.toggle("invalid",!validBM(inp.value))}};inp.addEventListener("input",val);val();inp.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();addRowBtn.click()}})});
}
function collectRowsFromEditor(){const rows=[];rowsBody.querySelectorAll(".et-row").forEach(div=>{const I=div.querySelectorAll("input");const kd=(I[0]?.value||"").trim();const pow=normalizePowerStr((I[1]?.value||"").trim());const kp=normalizePowerStr((I[2]?.value||"").trim());if(kd||pow||kp)rows.push([kd,pow,kp])});return rows}
campSelect.onchange=()=>{const old=currentEditorCampIndex;const rows=collectRowsFromEditor();if(camps[old])camps[old].rows=rows;currentEditorCampIndex=parseInt(campSelect.value||"0",10);renderRows();draw()}
addRowBtn.onclick=()=>{const idx=currentEditorCampIndex;const rows=collectRowsFromEditor();if(camps[idx])camps[idx].rows=rows;camps[idx].rows.push(["","",""]);renderRows()}
resetCampBtn.onclick=()=>{if(!confirm("Really clear this camp's data?"))return;const idx=currentEditorCampIndex;camps[idx].rows=[["","",""]];renderRows()}
applyDataBtn.onclick=()=>{const idx=currentEditorCampIndex;camps[idx].rows=collectRowsFromEditor();editorWrap.style.display="none";draw()}

/* Manual persistence */
saveDataBtn.onclick=()=>{localStorage.setItem(DATA_KEY,JSON.stringify(camps));alert("Data saved ‚úî")}
loadDataBtn.onclick=()=>{const raw=localStorage.getItem(DATA_KEY);if(!raw)return alert("No saved data.");try{const obj=JSON.parse(raw);if(!Array.isArray(obj))return alert("Invalid format.");obj.forEach(c=>{if(!c.id)c.id=uid();if(!c.totalTint)c.totalTint=mix(c.color||"#999","#000",0.75);if(!Array.isArray(c.rows))c.rows=[["","",""]];if(!c.stance)c.stance="neutral"});camps=obj;const newPos={};camps.forEach(c=>newPos[c.id]=pos[c.id]||[0.5,0.5]);pos=newPos;draw();alert("Data loaded ‚úî")}catch{alert("Error while loading.")}}
exportDataBtn.onclick=async()=>{const txt=JSON.stringify(camps,null,2);try{await navigator.clipboard.writeText(txt);alert("JSON copied ‚úî")}catch{const blob=new Blob([txt],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="siege_overlay_data.json";document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}}
importDataBtn.onclick=()=>{const txt=prompt("Paste JSON here:");if(!txt)return;try{const obj=JSON.parse(txt);if(!Array.isArray(obj))return alert("Invalid format.");obj.forEach(c=>{if(!c.id)c.id=uid();if(!c.totalTint)c.totalTint=mix(c.color||"#999","#000",0.75);if(!Array.isArray(c.rows))c.rows=[["","",""]];if(!c.stance)c.stance="neutral"});camps=obj;const newPos={};camps.forEach(c=>newPos[c.id]=pos[c.id]||[0.5,0.5]);pos=newPos;draw();alert("Data imported ‚úî")}catch{alert("Could not parse JSON.")}}

/* ====== Init: clear saved data & load Heroic Anthem (with map) ====== */
(function initDefault(){
  try{localStorage.removeItem(DATA_KEY);}catch(e){}
  presetSel.value="heroic4";
  titleInput.value=getPresetTitle();
  applyPreset("heroic4", false);
  loadMapForPreset("heroic4");
  draw();
})();
</script>
</body>
</html>
